<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>åˆé¤åœé¤/é€€è²»ç”³è«‹ç³»çµ±</title>
  
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ±</text></svg>">
  <meta property="og:title" content="åˆé¤åœé¤/é€€è²»ç”³è«‹ç³»çµ±">
  <meta property="og:description" content="ç·šä¸Šè¾¦ç†åˆé¤é€€è²»ç”³è«‹ï¼Œè«‹ç•™æ„ç”³è«‹æˆªæ­¢æ™‚é–“ã€‚">
  <meta property="og:type" content="website">

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans TC", sans-serif;
      background-color: #F2F2F7;
      color: #1C1C1E;
      -webkit-tap-highlight-color: transparent;
    }
    /* iOS Card & Inputs */
    .ios-card { background: white; border-radius: 1.25rem; box-shadow: 0 4px 20px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.03); }
    .ios-input { background: #F2F2F7; border: 1px solid transparent; border-radius: 10px; transition: all 0.2s; }
    .ios-input.focus { background: white; border-color: #007AFF; box-shadow: 0 0 0 3px rgba(0,122,255,0.15); outline: none; }
    .ios-input.error { background: #FFF2F2; border-color: #FF3B30; }
    .ios-btn-primary { background: #007AFF; color: white; border-radius: 12px; font-weight: 600; transition: all 0.2s; }
    .ios-btn-primary:active { transform: scale(0.98); opacity: 0.8; }
    .ios-btn-primary:disabled { background: #C7C7CC; cursor: not-allowed; transform: none; }
    
    /* Checkbox/Radio */
    input[type="radio"], input[type="checkbox"] { appearance: none; width: 1.35rem; height: 1.35rem; border: 2px solid #D1D1D6; border-radius: 50%; vertical-align: middle; position: relative; transition: all 0.2s; background: white; }
    input[type="checkbox"] { border-radius: 6px; }
    input[type="radio"]:checked, input[type="checkbox"]:checked { border-color: #007AFF; background: #007AFF; }
    input[type="radio"]:checked::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 0.5rem; height: 0.5rem; background: white; border-radius: 50%; }
    input[type="checkbox"]:checked::after { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: white; font-size: 0.8rem; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }

    /* Calendar Styling */
    .calendar-day { 
        border-radius: 12px; /* ç¨å¾®æ–¹ä¸€é»çš„åœ“è§’ */
        font-weight: 500; 
        position: relative; 
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
    }
    
    /* é¸ä¸­ç‹€æ…‹ï¼šæ¼¸å±¤è—è‰²ç«‹é«”æŒ‰éˆ• */
    .calendar-day.selected { 
        background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%) !important; 
        color: white !important; 
        font-weight: 700; 
        box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3), 0 2px 4px -1px rgba(37, 99, 235, 0.1);
        transform: scale(1.05);
        z-index: 10;
        border: none;
    }
    
    /* ä»Šå¤©ï¼šå¤–åœˆå…‰æšˆèˆ‡æ–‡å­—åŠ ç²— */
    .calendar-day.today { 
        font-weight: 800; 
        color: #2563EB; 
        background-color: #EFF6FF;
        border: 1px solid #BFDBFE;
    }
    .calendar-day.today::after { 
        content: ''; position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); 
        width: 4px; height: 4px; background-color: #2563EB; border-radius: 50%; 
    }
    .calendar-day.today.selected { 
        color: white; 
        background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%) !important;
        border: none;
    }
    .calendar-day.today.selected::after { background-color: white; }

    /* ç¦ç”¨ç‹€æ…‹ */
    .calendar-day.is-disabled { 
        color: #9CA3AF !important; 
        opacity: 0.6; 
        cursor: not-allowed !important; 
        background-color: transparent !important;
        border: 1px solid transparent;
    }
    
    /* å‡æ—¥é–å®š (å­¸æ ¡è¨­å®š) */
    .calendar-day.holiday-locked { 
        color: #EF4444 !important; /* ç´…è‰² */
        background-color: #FEF2F2 !important; /* æ·¡ç´…åº• */
        text-decoration: line-through;
        opacity: 0.8;
        cursor: not-allowed !important;
        border: 1px dashed #FECACA;
    }
    
    /* é€±æœ«ç´…å­— (ä¸€èˆ¬) */
    .calendar-day.holiday-text { color: #EF4444; }
    
    /* è£œç­æ—¥ (é»ƒåº•) */
    .calendar-day.makeup-day { 
        background-color: #FFFBEB; 
        color: #D97706; 
        border: 1px solid #FDE68A;
    }

    .required::after { content: " *"; color: #FF3B30; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    .modal-content { animation: fadeIn 0.25s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
  </style>
</head>
<body class="antialiased pb-10">

  <div class="max-w-2xl mx-auto my-6 px-3 sm:px-6 pt-4">
    <!-- Header -->
    <div class="mb-6 text-center sm:text-left">
      <h1 class="text-3xl font-bold text-gray-900 tracking-tight flex items-center justify-center sm:justify-start">
        <div class="w-10 h-10 bg-blue-500 rounded-xl flex items-center justify-center text-white mr-3 shadow-md bg-gradient-to-br from-blue-500 to-blue-600">
           <i class="fa-solid fa-utensils text-lg"></i>
        </div>
        åˆé¤åœé¤/é€€è²»ç”³è«‹
      </h1>
      <p class="text-gray-500 mt-1 ml-1 font-medium">æ¯é¤é€€è²»æ¨™æº– $60</p>
    </div>

    <!-- è¦å‰‡ -->
    <div class="ios-card p-4 sm:p-5 mb-6 bg-gradient-to-br from-blue-50 to-white border-blue-100">
      <h3 class="font-bold text-blue-600 mb-3 flex items-center text-sm uppercase tracking-wide">
        <i class="fa-solid fa-circle-info mr-2"></i> ç”³è«‹è¦å‰‡èˆ‡é ˆçŸ¥
      </h3>
      <div id="rule-display" class="mb-4 bg-white p-3 rounded-xl border border-blue-100 shadow-sm/50">
         <p class="text-xs text-gray-400 mb-1">ç³»çµ±è‡ªå‹•è¨ˆç®—æˆªç®—æ—¥...</p>
      </div>
      <ul class="space-y-3 text-sm text-gray-700">
        <li class="flex items-start"><span class="text-blue-500 mr-3 flex-shrink-0 text-lg leading-none mt-0.5">â€¢</span><span class="flex-1 leading-relaxed">è«‹æ–¼åœé¤æ—¥å¾€å‰<strong class="text-gray-900 mx-0.5">ç¬¬ 2 å€‹å·¥ä½œæ—¥ä¸‹åˆ 1:00 å‰</strong>æå‡ºã€‚</span></li>
        <li class="flex items-start"><span class="text-blue-500 mr-3 flex-shrink-0 text-lg leading-none mt-0.5">â€¢</span><span class="flex-1 leading-relaxed">é€¾æ™‚ç”³è«‹å› é£Ÿæå·²è¨‚è³¼ï¼Œ<span class="text-red-500 font-bold">ç„¡æ³•é€€è²»</span>ã€‚</span></li>
        <li class="flex items-start"><span class="text-blue-500 mr-3 flex-shrink-0 text-lg leading-none mt-0.5">â€¢</span><span class="flex-1 leading-relaxed">æ´½è©¢ï¼š<a href="tel:0222819980" target="_top" class="text-blue-600 font-bold hover:underline">02-22819980 åˆ†æ©Ÿ 9353</a></span></li>
      </ul>
    </div>

    <form id="refundForm" class="space-y-6" onsubmit="handleFormSubmit(event)">
      <div class="ios-card p-5 sm:p-6">
        <h2 class="text-lg font-bold text-gray-900 mb-5 flex items-center"><span class="bg-blue-100 text-blue-600 w-7 h-7 rounded-full flex items-center justify-center text-xs mr-2 font-bold">1</span>åŸºæœ¬è³‡æ–™</h2>
        <div class="space-y-6">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-3 required">åœé¤äº‹ç”±</label>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <label class="flex items-center p-3 rounded-xl border border-gray-100 bg-gray-50 hover:bg-blue-50 cursor-pointer transition-colors"><input type="radio" name="reason" value="æ³•å®šè«‹å‡(è…¸ç—…æ¯’ã€æ°´ç—˜)" required><span class="ml-3 text-sm font-medium">æ³•å®šè«‹å‡</span></label>
              <label class="flex items-center p-3 rounded-xl border border-gray-100 bg-gray-50 hover:bg-blue-50 cursor-pointer transition-colors"><input type="radio" name="reason" value="ç—…å‡"><span class="ml-3 text-sm font-medium">ç—…å‡</span></label>
              <label class="flex items-center p-3 rounded-xl border border-gray-100 bg-gray-50 hover:bg-blue-50 cursor-pointer transition-colors"><input type="radio" name="reason" value="äº‹å‡"><span class="ml-3 text-sm font-medium">äº‹å‡</span></label>
              <label class="flex items-center p-3 rounded-xl border border-gray-100 bg-gray-50 hover:bg-blue-50 cursor-pointer transition-colors"><input type="radio" name="reason" value="å…¶ä»–"><span class="ml-3 text-sm font-medium">å…¶ä»–</span></label>
            </div>
            <input type="text" id="reasonOtherInput" class="ios-input hidden mt-3 w-full text-sm" placeholder="è«‹è¼¸å…¥å…·é«”äº‹ç”±...">
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-3 required">ç”³è«‹é¡åˆ¥</label>
            <div class="bg-gray-50 p-1 rounded-xl flex">
              <label class="flex-1 text-center cursor-pointer"><input type="radio" name="applyType" value="individual" class="hidden peer" checked onchange="toggleStudentCount(false)"><div class="py-2 rounded-lg text-sm font-medium text-gray-500 peer-checked:bg-white peer-checked:text-blue-600 peer-checked:shadow-sm transition-all">å€‹äººç”³è«‹</div></label>
              <label class="flex-1 text-center cursor-pointer"><input type="radio" name="applyType" value="class" class="hidden peer" onchange="toggleStudentCount(true)"><div class="py-2 rounded-lg text-sm font-medium text-gray-500 peer-checked:bg-white peer-checked:text-blue-600 peer-checked:shadow-sm transition-all">å…¨ç­/å¤šäºº</div></label>
            </div>
            <div id="studentCountContainer" class="hidden mt-4 animate-fade-in">
              <div class="flex items-center"><input type="number" id="studentCount" name="studentCount" value="1" min="1" class="ios-input w-24 text-center font-bold text-lg" oninput="updateSummary()"><span class="ml-3 text-gray-500 text-sm">äºº</span></div>
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div><label class="block text-sm font-semibold text-gray-700 mb-2 required">ç­ç´šåº§è™Ÿ</label><input type="text" id="classSeat" name="classSeat" placeholder="ä¾‹ï¼š60123" class="ios-input w-full" required></div>
            <div><label class="block text-sm font-semibold text-gray-700 mb-2 required">å§“å</label><input type="text" id="name" name="name" class="ios-input w-full" required></div>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2 required">ç”¨é¤è‘·ç´ </label>
            <div class="flex space-x-6 mt-2">
              <label class="flex items-center cursor-pointer"><input type="radio" name="diet" value="è‘·" required><span class="ml-2 font-medium">è‘·é£Ÿ</span></label>
              <label class="flex items-center cursor-pointer"><input type="radio" name="diet" value="ç´ "><span class="ml-2 font-medium">ç´ é£Ÿ</span></label>
            </div>
          </div>
        </div>
      </div>

      <div class="ios-card p-5 sm:p-6 relative overflow-hidden">
        <!-- è£é£¾èƒŒæ™¯çƒ -->
        <div class="absolute -top-10 -right-10 w-32 h-32 bg-blue-50 rounded-full opacity-50 pointer-events-none"></div>

        <div class="flex items-center justify-between mb-5 relative z-10">
            <h2 class="text-lg font-bold text-gray-900 flex items-center"><span class="bg-blue-100 text-blue-600 w-7 h-7 rounded-full flex items-center justify-center text-xs mr-2 font-bold">2</span>é¸æ“‡æ—¥æœŸ</h2>
            <div class="flex space-x-1 bg-gray-100 p-1 rounded-full">
                <button type="button" onclick="changeMonth(-1)" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-white hover:shadow-sm text-gray-500 transition-all"><i class="fa-solid fa-chevron-left text-xs"></i></button>
                <button type="button" onclick="changeMonth(1)" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-white hover:shadow-sm text-gray-500 transition-all"><i class="fa-solid fa-chevron-right text-xs"></i></button>
            </div>
        </div>
        
        <!-- æ—¥æ›†å®¹å™¨ï¼šèƒŒæ™¯è‰²æ”¹ç‚ºæ›´æ¸…çˆ½çš„æ·¡è—è‰²æ¼¸å±¤ -->
        <div class="bg-gradient-to-b from-blue-50/50 to-white rounded-2xl p-4 mb-4 border border-blue-50">
          <div class="flex items-center justify-between mb-4">
            <span class="text-sm font-bold text-slate-700 flex items-center"><i class="fa-regular fa-calendar mr-2 text-blue-400"></i>åœé¤æ—¥æ›†</span>
            <div class="flex items-center text-[10px] sm:text-xs text-gray-400 space-x-2 sm:space-x-3">
              <span class="flex items-center"><span class="w-2 h-2 rounded-full bg-blue-500 mr-1 shadow-sm"></span>é¸å–</span>
              <span class="flex items-center"><span class="w-2 h-2 rounded-full border border-gray-300 mr-1 bg-white"></span>å¯é¸</span>
              <span class="flex items-center"><span class="w-2 h-2 rounded-full bg-red-100 mr-1 border border-red-200"></span>ä¸å¯</span>
            </div>
          </div>
          <p id="calendar-hint" class="text-xs text-gray-400 mb-2 flex items-center"><i class="fa-solid fa-circle-info mr-1 text-blue-300"></i>é»æ“Šç°è‰²/ç´…è‰²æ—¥æœŸå¯æŸ¥çœ‹åŸå› </p>
          <div id="calendar-wrapper" class="space-y-6 select-none"></div>
        </div>

        <div class="bg-slate-800 rounded-2xl p-5 text-white shadow-xl shadow-slate-200 relative z-10">
          <div class="grid grid-cols-3 gap-4 text-center divide-x divide-slate-600">
            <div><div class="text-xs text-slate-400 mb-1">äººæ•¸</div><input type="text" id="displayStudentCount" readonly class="bg-transparent text-center text-xl font-bold w-full text-white outline-none font-mono" value="1"></div>
            <div><div class="text-xs text-slate-400 mb-1">å¤©æ•¸</div><input type="number" id="totalDays" name="totalDays" readonly class="bg-transparent text-center text-xl font-bold w-full text-white outline-none font-mono" value="0"></div>
            <div><div class="text-xs text-slate-400 mb-1">ç¸½é‡‘é¡</div><div class="text-xl font-bold text-blue-300 font-mono">$<span id="totalAmount">0</span></div></div>
          </div>
          <div id="selected-dates-display" class="mt-4 pt-4 border-t border-slate-700 text-xs text-slate-300 min-h-[30px] flex flex-wrap gap-2"><span class="italic opacity-50">è«‹é¸æ“‡ä¸Šæ–¹æ—¥æœŸ...</span></div>
          <input type="hidden" id="dateInput" name="dateInput" required>
        </div>
      </div>

      <div class="ios-card p-5 sm:p-6">
        <h2 class="text-lg font-bold text-gray-900 mb-4 flex items-center"><span class="bg-blue-100 text-blue-600 w-7 h-7 rounded-full flex items-center justify-center text-xs mr-2 font-bold">3</span>ç¤¾åœ˜èª¿æŸ¥</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3" id="club-container"></div>
      </div>

      <div class="pb-6">
        <button type="submit" id="submitBtn" class="ios-btn-primary w-full py-4 text-lg shadow-lg hover:shadow-xl shadow-blue-500/20 disabled:shadow-none bg-gradient-to-r from-blue-600 to-blue-500">æäº¤ç”³è«‹</button>
      </div>
    </form>
    
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded-2xl shadow-2xl text-center w-64">
        <div class="animate-spin rounded-full h-10 w-10 border-[3px] border-blue-100 border-t-blue-500 mx-auto mb-4"></div>
        <p class="text-gray-600 font-medium">è™•ç†ä¸­...</p>
      </div>
    </div>
    <div id="successModal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-md flex items-center justify-center z-50 p-4">
      <div class="modal-content bg-white p-8 rounded-3xl shadow-2xl text-center max-w-sm w-full">
        <div class="w-16 h-16 bg-green-100 text-green-500 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl shadow-sm"><i class="fa-solid fa-check"></i></div>
        <h3 class="text-2xl font-bold text-gray-900 mb-2">ç”³è«‹æˆåŠŸ</h3>
        <p class="text-gray-500 mb-8">ç³»çµ±å·²æ”¶åˆ°æ‚¨çš„è³‡æ–™ï¼Œ<br>è«‹ç•™æ„é€€è²»é€šçŸ¥ã€‚</p>
        <button onclick="closeSuccessModal()" class="ios-btn-primary w-full py-3.5">å®Œæˆ</button>
      </div>
    </div>
    <div id="infoModal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-md flex items-center justify-center z-50 p-4">
      <div class="modal-content bg-white p-6 rounded-2xl shadow-2xl text-center max-w-xs w-full">
        <div class="mb-3 text-amber-400 text-4xl drop-shadow-sm"><i class="fa-solid fa-circle-exclamation"></i></div>
        <h3 class="text-lg font-bold text-gray-900 mb-2" id="infoModalTitle">æç¤º</h3>
        <p class="text-gray-600 mb-6 text-sm" id="infoModalMessage">è¨Šæ¯å…§å®¹</p>
        <button onclick="closeInfoModal()" class="bg-gray-100 text-gray-700 hover:bg-gray-200 font-bold py-2.5 px-4 rounded-xl w-full transition-colors">æˆ‘çŸ¥é“äº†</button>
      </div>
    </div>
  </div>

  <script>
    // --- âš ï¸ è«‹ç¢ºèªå¡«å…¥æ­£ç¢ºçš„ API ç¶²å€ âš ï¸ ---
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbyh7Bep2D8xivGee2-dGbGp8A1wXYPYR9kI0vuF3GOq4czWxjeGw2cTBaxAhGTp491vng/exec"; 

    const COST_PER_MEAL = 60;
    // é è¨­è£œç­æ—¥èˆ‡åœ‹å®šå‡æ—¥ (ç•¶å¾Œç«¯æ²’è³‡æ–™æ™‚çš„å‚™æ¡ˆï¼Œå¹´ä»½è«‹æ ¹æ“šå¯¦éš›æƒ…æ³èª¿æ•´)
    const MAKEUP_DAYS = ["2025/2/8"];
    const DEFAULT_HOLIDAYS = ["2025/1/1", "2025/1/27", "2025/1/28", "2025/1/29", "2025/1/30", "2025/1/31", "2025/2/28", "2025/4/3", "2025/4/4"];
    
    const CLUB_OPTIONS = ["å…¨éƒ¨æœªåƒåŠ ","1.2å¹´ç´šèª²å¾Œç­(ä¸€.å››.äº”)","3.4å¹´ç´šèª²å¾Œç­(äº”)","1.2å¹´ç´šç¾½çƒéšŠ(ä¸€. å››.äº”)","3.4å¹´ç´šç¾½çƒéšŠ(äº”)","é€±ä¸‰(ç¾½çƒéšŠ)","é€±ä¸‰ç±ƒçƒç­A","é€±ä¸‰ç±ƒçƒç­B","é€±ä¸‰ç±ƒçƒç­C","é€±ä¸‰æ‰è—ç­(æµè¡Œmvèˆè¹ˆç­)","é€±ä¸‰æ‰è—ç­(è‹±èªåˆéšè‡ªç„¶ç™¼éŸ³ç­P4-P6)ç­","é€±ä¸‰æ‰è—ç­(è‹±èªç¤¾åœ˜åŸºç¤å­—å½™ç­V1-V3)","é€±ä¸‰æ‰è—ç­(å¹¸ç¦æä¸€ä¸‹A)","é€±ä¸‰æ‰è—ç­(å‰µæ„DIY-ç¦®å“ï¼†é»å¿ƒå°é‹ª)","é€±ä¸‰æ‰è—ç­(å…’ç«¥å‰µæ„ç¾è¡“)","é€±ä¸‰æ‰è—ç­(æ•¸å­¸æ¡ŒéŠç¤¾å¯¶å¯å¤¢)","é€±ä¸‰æ‰è—ç­(æ€ä¸(STEAM)å‰µå®¢å¥½å°å­)","é€±ä¸‰æ‰è—ç­(å‹•æ¼«å¹³æ¿ç¹ªåœ–èˆ‡æ‰‹ä½œå‰µä½œç‡Ÿ)","é€±ä¸‰æ‰è—ç­(é»‘é·¹è¶³çƒç¤¾åœ˜èª²)","é€±äº”ç±ƒçƒç­A","å…¶ä»–"];

    // ç³»çµ±é‹ä½œè®Šæ•¸
    let HOLIDAYS = [...DEFAULT_HOLIDAYS];
    let earliestValidDateObj = null;
    let earliestValidDateStr = "";
    let selectedDatesSet = new Set();
    let currentStudentCount = 1;
    let currentCalendarBaseDate = new Date(); 

    document.addEventListener('DOMContentLoaded', () => {
      renderClubs();
      initReasonToggle();
      fetchHolidays(); // ä»ç„¶è¦è®€å–å‡æ—¥ï¼Œä½†ä¾†æºæ˜¯è©¦ç®—è¡¨
      setInterval(updateDashboard, 1000);
    });

    async function safeFetch(data) {
        if (!GAS_API_URL || GAS_API_URL.includes("åœ¨æ­¤è™•è²¼ä¸Š")) throw new Error("è«‹å…ˆè¨­å®šæ­£ç¢ºçš„ GAS_API_URL");
        const response = await fetch(GAS_API_URL, {
            method: "POST",
            body: JSON.stringify(data),
            headers: { "Content-Type": "text/plain;charset=utf-8" },
        });
        if (!response.ok) throw new Error(`ä¼ºæœå™¨å›æ‡‰éŒ¯èª¤: ${response.status}`);
        const text = await response.text();
        try { return JSON.parse(text); } catch (e) { throw new Error("é€£ç·šå¤±æ•—ï¼šå›å‚³è³‡æ–™æ ¼å¼éŒ¯èª¤"); }
    }

    // è®€å–å‡æ—¥è¨­å®š (å–®ç´”è®€å–ï¼Œä¸æä¾›ä¿®æ”¹)
    function fetchHolidays() {
        safeFetch({ action: 'getHolidays' })
        .then(data => {
            if (data.result === 'success' && Array.isArray(data.holidays)) {
                if (data.holidays.length > 0) {
                    HOLIDAYS = data.holidays;
                }
            }
            calculateDeadlineRule();
            renderCalendar();
        })
        .catch(err => { 
            console.warn("è¼‰å…¥è¨­å®šå¤±æ•— (ä½¿ç”¨é è¨­å€¼):", err.message); 
            calculateDeadlineRule(); 
            renderCalendar(); 
        });
    }

    function handleFormSubmit(e) {
      e.preventDefault();
      const form = document.getElementById('refundForm');
      const formData = new FormData(form);
      const data = {};
      const clubs = [];
      document.querySelectorAll('input[name="clubs"]:checked').forEach(cb => clubs.push(cb.value));
      formData.forEach((value, key) => { if (key !== 'clubs') data[key] = value; });
      if (data['reason'] === 'å…¶ä»–') { const t = document.getElementById('reasonOtherInput').value.trim(); if(t) data['reason'] = `å…¶ä»–ï¼š${t}`; }
      data['clubs'] = clubs.join(', ');
      if (data['applyType'] === 'individual') data['studentCount'] = 1;
      document.getElementById('loadingOverlay').classList.remove('hidden');
      safeFetch(data).then(result => { if (result.result === "success") onSuccess(); else onFailure(new Error(result.error || "Unknown")); }).catch(onFailure);
    }
    
    function toggleStudentCount(isClass) {
      const el = document.getElementById('studentCountContainer');
      const inp = document.getElementById('studentCount');
      if (isClass) { el.classList.remove('hidden'); inp.value = ""; inp.focus(); inp.classList.add('error'); currentStudentCount=0; }
      else { el.classList.add('hidden'); inp.value = "1"; inp.classList.remove('error'); currentStudentCount=1; }
      updateSummary();
    }
    
    function initReasonToggle() {
      const radios = document.querySelectorAll('input[name="reason"]');
      const input = document.getElementById('reasonOtherInput');
      radios.forEach(r => r.addEventListener('change', e => { if(e.target.value === 'å…¶ä»–') { input.classList.remove('hidden'); input.required=true; input.focus(); } else { input.classList.add('hidden'); input.required=false; input.value=''; } }));
    }
    
    function changeMonth(delta) { currentCalendarBaseDate.setMonth(currentCalendarBaseDate.getMonth() + delta); renderCalendar(); }
    
    function renderCalendar() {
        document.getElementById('calendar-wrapper').innerHTML = ''; 
        renderMonth(currentCalendarBaseDate.getFullYear(), currentCalendarBaseDate.getMonth());
        const next = new Date(currentCalendarBaseDate.getFullYear(), currentCalendarBaseDate.getMonth() + 1, 1);
        renderMonth(next.getFullYear(), next.getMonth());
    }
    
    function formatDateKey(date) { return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`; }
    
    function toggleDateSelection(dateStr, btnElement) {
      if (selectedDatesSet.has(dateStr)) { selectedDatesSet.delete(dateStr); btnElement.classList.remove('selected'); }
      else { selectedDatesSet.add(dateStr); btnElement.classList.add('selected'); }
      updateSummary();
    }
    
    function updateSummary() {
      const inp = document.getElementById('studentCount');
      currentStudentCount = parseInt(inp.value) || 0;
      if (currentStudentCount <= 0 && !document.getElementById('studentCountContainer').classList.contains('hidden')) inp.classList.add('error'); else inp.classList.remove('error');
      document.getElementById('displayStudentCount').value = currentStudentCount;
      const sorted = Array.from(selectedDatesSet).sort((a,b) => new Date(a)-new Date(b));
      const display = document.getElementById('selected-dates-display');
      if (sorted.length===0) display.innerHTML = '<span class="italic opacity-50">è«‹é¸æ“‡ä¸Šæ–¹æ—¥æœŸ...</span>';
      else display.innerHTML = sorted.map(d => `<span class="bg-blue-500 text-white px-2 py-0.5 rounded-md shadow-sm border border-blue-600">${d}</span>`).join('');
      document.getElementById('dateInput').value = sorted.join(', ');
      const days = sorted.length;
      document.getElementById('totalDays').value = days;
      document.getElementById('totalAmount').innerText = (days * currentStudentCount * COST_PER_MEAL).toLocaleString();
      const btn = document.getElementById('submitBtn');
      if (days===0 || currentStudentCount<=0) { btn.disabled=true; btn.innerText = (days===0?"è«‹é¸æ“‡åœé¤æ—¥æœŸ":"è«‹è¼¸å…¥æ­£ç¢ºäººæ•¸"); } else { btn.disabled=false; btn.innerText="æäº¤ç”³è«‹"; }
    }
    
    // --- æ–°ç‰ˆç¤¾åœ˜æ¸²æŸ“é‚è¼¯ (è¦–è¦ºå„ªåŒ–) ---
    function getClubStyle(name) {
        // é è¨­æ¨£å¼
        let s = { icon: "fa-shapes", color: "text-blue-500", bg: "peer-checked:bg-blue-50", border: "peer-checked:border-blue-500" };
        
        if (name.includes("æœªåƒåŠ ")) s = { icon: "fa-ban", color: "text-gray-500", bg: "peer-checked:bg-gray-100", border: "peer-checked:border-gray-400" };
        else if (name.includes("èª²å¾Œç­")) s = { icon: "fa-school", color: "text-emerald-500", bg: "peer-checked:bg-emerald-50", border: "peer-checked:border-emerald-500" };
        else if (name.includes("ç¾½çƒ")) s = { icon: "fa-feather", color: "text-cyan-500", bg: "peer-checked:bg-cyan-50", border: "peer-checked:border-cyan-500" };
        else if (name.includes("ç±ƒçƒ")) s = { icon: "fa-basketball", color: "text-orange-500", bg: "peer-checked:bg-orange-50", border: "peer-checked:border-orange-500" };
        else if (name.includes("è¶³çƒ")) s = { icon: "fa-futbol", color: "text-blue-600", bg: "peer-checked:bg-blue-50", border: "peer-checked:border-blue-600" };
        else if (name.includes("èˆè¹ˆ") || name.includes("mv")) s = { icon: "fa-music", color: "text-pink-500", bg: "peer-checked:bg-pink-50", border: "peer-checked:border-pink-500" };
        else if (name.includes("è‹±èª")) s = { icon: "fa-language", color: "text-violet-500", bg: "peer-checked:bg-violet-50", border: "peer-checked:border-violet-500" };
        else if (name.includes("ç¾è¡“") || name.includes("ç¹ªåœ–") || name.includes("DIY") || name.includes("æ")) s = { icon: "fa-palette", color: "text-fuchsia-500", bg: "peer-checked:bg-fuchsia-50", border: "peer-checked:border-fuchsia-500" };
        else if (name.includes("æ•¸å­¸") || name.includes("STEAM") || name.includes("å‰µå®¢")) s = { icon: "fa-rocket", color: "text-rose-500", bg: "peer-checked:bg-rose-50", border: "peer-checked:border-rose-500" };
        
        return s;
    }

    function renderClubs() {
      const con = document.getElementById('club-container');
      con.innerHTML = ''; // å…ˆæ¸…ç©º
      
      CLUB_OPTIONS.forEach((c,i) => {
         const style = getClubStyle(c);
         
         const html = `
         <label class="relative group cursor-pointer w-full">
            <input type="checkbox" name="clubs" value="${c}" id="club_${i}" class="peer sr-only">
            <div class="flex items-center p-3 rounded-2xl border-2 border-transparent bg-white ring-1 ring-gray-100 shadow-sm transition-all duration-200 
                        hover:shadow-md hover:bg-gray-50 
                        ${style.bg} ${style.border} peer-checked:ring-0 peer-checked:shadow-md">
                
                <div class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center flex-shrink-0 mr-3 ${style.color} bg-opacity-20">
                    <i class="fa-solid ${style.icon} text-lg"></i>
                </div>
                
                <div class="flex-1">
                    <span class="text-sm font-bold text-gray-700 peer-checked:text-gray-900 block leading-tight">${c}</span>
                </div>

                <div class="w-6 h-6 rounded-full border-2 border-gray-200 ml-2 flex items-center justify-center peer-checked:border-transparent peer-checked:bg-current ${style.color}">
                    <i class="fa-solid fa-check text-white text-xs opacity-0 peer-checked:opacity-100 transform scale-50 peer-checked:scale-100 transition-all"></i>
                </div>
            </div>
         </label>
         `;
         con.insertAdjacentHTML('beforeend', html);
      });

      // é‡æ–°ç¶å®š "å…¨éƒ¨æœªåƒåŠ " çš„äº’æ–¥é‚è¼¯
      const none = document.getElementById('club_0'); 
      const others = Array.from(document.querySelectorAll('input[name="clubs"]:not(#club_0)'));
      
      none.addEventListener('change', e => { 
          if(e.target.checked) {
              others.forEach(cb => { 
                  cb.checked=false; 
                  cb.disabled=true; 
                  // è¦–è¦ºä¸Šçš„ç¦ç”¨æ•ˆæœ (é‡å°çˆ¶å®¹å™¨ label åŠ ä¸Šé€æ˜åº¦èˆ‡ç°éš)
                  cb.parentElement.classList.add('opacity-50', 'grayscale', 'cursor-not-allowed');
              }); 
          } else { 
              others.forEach(cb => { 
                  cb.disabled=false; 
                  // æ¢å¾©è¦–è¦ºæ•ˆæœ
                  cb.parentElement.classList.remove('opacity-50', 'grayscale', 'cursor-not-allowed');
              }); 
          } 
      });
    }
    
    function updateDashboard() {
      const now = new Date(); const hr = now.getHours();
      let base = new Date(now); let add = (hr>=13)?3:2;
      earliestValidDateObj = addWorkDays(base, add); earliestValidDateStr = formatDateFull(earliestValidDateObj);
      let target = new Date(now); target.setHours(13,0,0,0); if(now>target) target.setDate(target.getDate()+1);
      const diff = target-now;
      const h=Math.floor((diff%(864e5))/36e5), m=Math.floor((diff%36e5)/6e4), s=Math.floor((diff%6e4)/1e3);
      const el = document.getElementById('rule-display');
      if(el) el.innerHTML = `<div class="flex flex-col space-y-2"><div class="flex justify-between items-center text-xs text-gray-500"><span>ç¾åœ¨æ™‚åˆ»ï¼š${formatDateFull(now)} ${now.toLocaleTimeString()}</span></div><div class="flex items-center text-sm bg-red-50 p-2 rounded-lg border border-red-100"><i class="fa-solid fa-hourglass-half text-red-500 mr-2"></i><span class="text-gray-600 mr-2">æ”¶å–®å€’æ•¸ï¼š</span><span class="text-red-600 font-bold font-mono text-lg">${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}</span></div><div class="text-sm font-bold text-blue-600 flex items-center mt-1"><span class="text-xs text-gray-400 font-normal mr-2">æœ€æ—©å¯é€€è²»æ—¥</span>${earliestValidDateStr}</div></div>`;
    }
    
    function calculateDeadlineRule() { updateDashboard(); }
    
    function isWorkDay(date) {
      const dateStr = formatDateKey(date);
      if (HOLIDAYS.includes(dateStr)) return false;
      if (MAKEUP_DAYS.includes(dateStr)) return true;
      const day = date.getDay();
      if (day === 0 || day === 6) return false;
      return true;
    }
    
    function addWorkDays(date, days) {
      let cur = new Date(date); let add = 0;
      while(add < days) { cur.setDate(cur.getDate()+1); if(isWorkDay(cur)) add++; }
      return cur;
    }
    
    function formatDateSimple(d) { return `${d.getMonth()+1}/${d.getDate()}`; }
    function formatDateFull(d) { return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')} (${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()]})`; }
    function showInfoModal(t, m) { document.getElementById('infoModalTitle').innerText=t; document.getElementById('infoModalMessage').innerText=m; document.getElementById('infoModal').classList.remove('hidden'); }
    function closeInfoModal() { document.getElementById('infoModal').classList.add('hidden'); }
    function onSuccess() {
      document.getElementById('loadingOverlay').classList.add('hidden'); document.getElementById('refundForm').reset(); selectedDatesSet.clear();
      currentCalendarBaseDate = new Date(); renderCalendar(); toggleStudentCount(false); fetchHolidays(); updateSummary();
      const others = Array.from(document.querySelectorAll('input[name="clubs"]:not(#club_0)')); others.forEach(cb => { cb.disabled=false; cb.parentElement.classList.remove('opacity-50','grayscale', 'cursor-not-allowed'); });
      document.getElementById('successModal').classList.remove('hidden');
    }
    function closeSuccessModal() { document.getElementById('successModal').classList.add('hidden'); }
    function onFailure(e) { document.getElementById('loadingOverlay').classList.add('hidden'); alert(e.message); }

    function renderMonth(year, month) {
      const wrapper = document.getElementById('calendar-wrapper');
      const monthContainer = document.createElement('div');
      const displayDate = new Date(year, month, 1);
      const rocYear = displayDate.getFullYear() - 1911;
      
      const title = document.createElement('div');
      title.className = "text-center font-bold text-slate-700 mb-4 text-base bg-white/50 py-1 rounded-lg mx-auto w-1/2 shadow-sm border border-white";
      title.innerText = `æ°‘åœ‹${rocYear}å¹´ ${displayDate.getMonth() + 1}æœˆ`;
      monthContainer.appendChild(title);
      
      const weekHeader = document.createElement('div');
      weekHeader.className = "grid grid-cols-7 gap-1 mb-2 text-center text-[10px] font-bold uppercase tracking-wider";
      
      const weekDays = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
      weekDays.forEach((d, i) => { 
        const s = document.createElement('span'); 
        s.innerText = d; 
        // é€±æœ«è‰²å½©é‚è¼¯
        if (i === 0) s.className = "text-red-500"; // é€±æ—¥ç´…
        else if (i === 6) s.className = "text-orange-500"; // é€±å…­æ©˜
        else s.className = "text-slate-400";
        weekHeader.appendChild(s); 
      });
      monthContainer.appendChild(weekHeader);
      
      const grid = document.createElement('div');
      grid.className = "grid grid-cols-7 gap-1 sm:gap-2";
      
      const firstDay = new Date(year, month, 1);
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const startDayOfWeek = firstDay.getDay(); 
      const today = new Date();
      
      for (let i = 0; i < startDayOfWeek; i++) grid.appendChild(document.createElement('div'));
      
      for (let d = 1; d <= daysInMonth; d++) {
        const dateObj = new Date(year, month, d);
        const dateStr = formatDateKey(dateObj); 
        const btn = document.createElement('button');
        btn.type = "button"; btn.innerText = d;
        btn.className = "calendar-day h-10 w-full flex items-center justify-center text-sm hover:bg-white hover:shadow-sm"; // åŸºç¤æ¨£å¼
        
        btn.style.color = '';
        btn.style.backgroundColor = '';

        const dayOfWeek = dateObj.getDay();
        const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
        
        // ç›´æ¥åˆ¤æ–·æ˜¯å¦ç‚ºä¸ä¾›é¤æ—¥
        let isHoliday = HOLIDAYS.includes(dateStr);
        const isMakeup = MAKEUP_DAYS.includes(dateStr); 
        const isToday = (dateObj.toDateString() === today.toDateString());

        if (isToday) btn.classList.add('today');

        // --- ä¸€èˆ¬å®¶é•·æ¨¡å¼é‚è¼¯ ---
        const compareDate = new Date(dateObj); compareDate.setHours(0,0,0,0);
        const thresholdDate = new Date(earliestValidDateObj); thresholdDate.setHours(0,0,0,0);
        
        let isDisabled = false;
        let disableReason = "";

        if (compareDate < thresholdDate) { 
            isDisabled = true; 
            disableReason = `å·²è¶…éç”³è«‹æœŸé™\n(éœ€æ–¼ ${formatDateSimple(earliestValidDateObj)} (å«)ä»¥å¾Œæ‰å¯é€€è²»)`; 
        }
        else if (isHoliday) { 
            isDisabled = true; 
            disableReason = "éä¾›é¤æ—¥ (å­¸æ ¡è¨­å®š)"; 
            btn.classList.add('holiday-locked'); 
        }
        else if (!isMakeup && isWeekend) { 
            isDisabled = true; 
            disableReason = "éä¾›é¤æ—¥ (é€±æœ«)";
            btn.classList.add('holiday-text'); 
        }
        
        if (isMakeup) btn.classList.add('makeup-day');

        if (isDisabled) {
            btn.classList.add('is-disabled');
            btn.onclick = () => showInfoModal(`ç„¡æ³•é¸æ“‡ ${dateStr}`, `åŸå› ï¼š${disableReason}`);
        } else {
            btn.onclick = () => toggleDateSelection(dateStr, btn);
            if (selectedDatesSet.has(dateStr)) btn.classList.add('selected');
        }
        
        grid.appendChild(btn);
      }
      monthContainer.appendChild(grid); wrapper.appendChild(monthContainer);
    }
  </script>
</body>
</html>
